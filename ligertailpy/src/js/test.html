<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js">
  </script>
  <script src = "../js/json2.js">
  </script>
  <script src = "../js/postrequest_orig.js">
  </script>
  <script src = "../js/apiproxy.js">
  </script>
  <script src = "../js/baseapihandler.js">
  </script>
 </head>
  <body>
<h1>Test Ligertail</h1>    
  <body>
  <input type='BUTTON' value = "Start test" onclick='init()'/>
  <input type='BUTTON' value = "Stop test" onclick='stop()'/>
  <div>Requests per minute: </div><INPUT TYPE="text"  class='requestsPerMinute' ID="requestsPerMinute" VALUE=""></INPUT>
  <br/>
  <b>number of tests left:</b> <span class ='numTestsLeft' id='numTestsLeft'></span><br/>
  <b>successes:</b><div color='green' class='success' id='success'></div>
  <b>failures:</b><div color='red' class='failure' id='failure'></div>
  <b>error:</b> <div class='error' id='error'></div>
  <b>output:</b> <div class='output' id='output'></div>
  
  <script language="javascript">
  var successes = 0;
  var failures = 0;
  var started = false;
  var initialized = false;
  var requestsPerMinute = 10;
  var submitViewRatio = 0.1;
  var lttest = {};
  jQuery('#requestsPerMinute').val(requestsPerMinute);
  function init (){
		 if (!initialized) {
	     var apiHandler = new BaseApiHandler();
	     lttest.api = new LTApi();
	     lttest.api.init(apiHandler);
	     lttest.currentItem = 0;
	     lttest.token = ''+ Math.random() + '_';
	     print('Starting testing.');
		   initialized = true;
		 } 
	   if (initialized && !started) {
		   started = true;
		   recalculateTimeouts();
		   setTimeout('submitItem()', lttest.msecSubmit);
		   setTimeout('getItemsAndSubmitInteraction()', lttest.msecView);
	   }
	 }
  
   function recalculateTimeouts() {
	     requestsPerMinute =jQuery('#requestsPerMinute').val();
	     if (requestsPerMinute < 1) {
	    	 requestsPerMinute = 1;
	    	 jQuery('#requestsPerMinute').val(requestsPerMinute);
	     }
       var delta = 60.0 * 1000.0 / requestsPerMinute;
       lttest.msecSubmit = delta / submitViewRatio;
       lttest.msecView = delta / (1.0-submitViewRatio);
   }
   
   function stop() {
     started = false;
   }
  
   function submitItem() {
	   if (started) {
       var item = createItem(lttest.token + lttest.currentItem);
       lttest.api.submitItem(item, 'onItemSubmitted');
       lttest.currentItem += 1;
       setTimeout('submitItem()', lttest.msecSubmit);
	   }
   }
     
    function createItem(n) {
    	  var item = {};
    	  item.publisherUrl = publisherUrl();
   		  item.url = "www.url" + n + ".com";
   		  item.title = "i" + n;
   		  item.description = "Item" + n + " description";
   		  item.email = "email@emal.com";
   		  return item;
    }
    
    
    function onItemSubmitted(response) {
    	if (response.error) {
    		failure(response.error);
    	} else {
    		success();
    	}
    }
    
    function getItemsAndSubmitInteraction() {
    	if (started) {
        lttest.api.getOrderedItems(publisherUrl(), 'onGetOrderedItems');
        setTimeout('getItemsAndSubmitInteraction()', lttest.msecView);
    	}
    }
    
    function onGetOrderedItems(response) {
      if (response.error) {
        failure(response.error);
        return;
      }
      success();
      its = []
      jQuery.each(response.items, function(i, item){
          its.push( jQuery.parseJSON(item));
      });

      print('number of ordered items ' + response.items.length);
      submitUserInteraction(its);
    }
    
    function submitUserInteraction(items) {
        // Submit user interactions.
        interactions = [];
        var size = Math.min(items.length, 5);
        for (var i = 0; i < size; i++) {
          interactions.push({itemId: items[i].id, statType: StatType.VIEWS, spot: i});
        }
        var i1 = Math.floor(Math.random() * size);
        var i2 = Math.floor(Math.random() * size);
        interactions.push({itemId: items[i1].id, statType: StatType.CLOSES, spot: i1 + 1});
        interactions.push({itemId: items[i2].id, statType: StatType.CLICKS, spot: i2 + 1});
        lttest.api.submitUserInteraction(publisherUrl(), interactions, 'onUserInteractionSubmitted');
    }
    
   
    function onUserInteractionSubmitted(response) {
        if (response.error) {
            failure(response.error);
            return;
        }
        success();    	
    }
    
    function publisherUrl() {
       return window.document.location.href;
    }
   
    
    function print(s) {
      jQuery("#output").html(jQuery('#output').html() + '<br\>' + s);
    }
    
    function success() {
    	successes += 1;
      jQuery("#success").html(successes);
    }
    
    function failure(s) {
      failures += 1;
      jQuery("#failure").html(failures);
      jQuery("#error").prepend('<p>' + s + '</p>');

    }

   </script>
 </body>
</html>